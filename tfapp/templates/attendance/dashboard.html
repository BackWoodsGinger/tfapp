{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-12 col-md-10 col-sm-12">

      <div class="card mb-4">
        <div class="card-body">
          <h3>Welcome, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}</h3>

          <h5 class="mt-4">Occurrences for Selected Day</h5>
          <form method="get" class="row g-2 mb-3">
            <div class="col-sm-6 col-md-4 col-lg-3">
              <input type="date" name="date" class="form-control" value="{{ selected_date|date:'Y-m-d' }}">
            </div>
            <div class="col-auto">
              <button class="btn btn-sm btn-primary" type="submit">Filter</button>
            </div>
          </form>

          <table class="table table-sm table-bordered">
            <thead>
              <tr>
                <th>User</th>
                <th>Type</th>
                <th>Subtype</th>
                <th>Hours</th>
              </tr>
            </thead>
            <tbody>
              {% for occ in daily_occurrences %}
              <tr>
                <td>{{ occ.user.get_full_name|default:occ.user.username }}</td>
                <td>{{ occ.get_occurrence_type_display }}</td>
                <td>{{ occ.get_subtype_display }}</td>
                <td>{{ occ.duration_hours }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4">No occurrences on this day.</td></tr>
              {% endfor %}
            </tbody>
          </table>

          {% if user_list|length > 1 %}
          <form method="get" class="mt-3">
            <label for="user_id">View Absences For:</label>
            <select name="user_id" id="user_id" class="form-select w-auto d-inline-block" onchange="this.form.submit()">
              {% for u in user_list %}
              <option value="{{ u.id }}" {% if selected_user.id == u.id %}selected{% endif %}>
                {{ u.get_full_name|default:u.username }}
              </option>
              {% endfor %}
            </select>
          </form>
          {% endif %}
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <h5>Paid Time Off Balance ({{ selected_user.get_full_name|default:selected_user.username }})</h5>
          <ul>
            <li>Current PTO: {{ current_pto }} hrs</li>
            <li>Pending PTO: {{ pending_hours }} hrs</li>
            <li>Balance After Pending: {{ balance_after_pending }} hrs</li>
            {% if final_year_balance %}
            <li>Final Year Balance: {{ final_year_balance }} hrs</li>
            {% endif %}
            <li>Personal Time: {{ personal_time }} hrs</li>
            <li>Future Personal: {{ future_personal }} hrs</li>
          </ul>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <h5>Past Occurrences (since last service date)</h5>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Date</th><th>Type</th><th>Subtype</th><th>Hours</th>
              </tr>
            </thead>
            <tbody>
              {% for occ in past_occurrences %}
              <tr>
                <td>{{ occ.date }}</td>
                <td>{{ occ.get_occurrence_type_display }}</td>
                <td>{{ occ.get_subtype_display }}</td>
                <td>{{ occ.duration_hours }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4">No past occurrences.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <h5>Upcoming Occurrences</h5>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Date</th><th>Type</th><th>Subtype</th><th>Hours</th>
              </tr>
            </thead>
            <tbody>
              {% for occ in future_occurrences %}
              <tr>
                <td>{{ occ.date }}</td>
                <td>{{ occ.get_occurrence_type_display }}</td>
                <td>{{ occ.get_subtype_display }}</td>
                <td>{{ occ.duration_hours }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4">No upcoming occurrences.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}